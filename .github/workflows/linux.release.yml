# Generated by mk-workflows.

name: "linux-release"
on:
  release:
    types: [created]

jobs:
  linux-release:
    runs-on: ubuntu-20.04
    container: ghcr.io/pragmatrix/rust-skia-linux:latest

    steps:
      - uses: actions/checkout@v2

      - name: Prepare Rustup
        run: (cd /github/home && ln -s /root/.cargo)

      - name: Update Rustup and Rust
        run: rustup update

      - name: Configure Rust Toolchain
        run: rustup default stable

      - name: Install Clippy
        run: rustup component add clippy
      - name: "Install Rust target x86_64-unknown-linux-gnu"
        shell: bash
        run: |
          rustup target add x86_64-unknown-linux-gnu

      - name: "Build"
        shell: bash
        run: |
          cargo clean
          cargo build --release
          echo "STROKE_PATH=${BUILD_ARTIFACTSTAGINGDIRECTORY}" >> ${GITHUB_ENV}
        env:
          BUILD_ARTIFACTSTAGINGDIRECTORY: ${{ runner.temp }}


      - name: "Compress binaries"
        if: true
        uses: master-atul/tar-action@v1.0.2
        with:
          command: c
          cwd: "./target/release"
          files: "stroke"
          outPath: "${{ runner.temp }}/stroke-binaries-${{ github.ref_name }}.tar.gz"

      - name: "Release binaries"
        if: true
        uses: pragmatrix/release-action@exp
        with:
          owner: meloalright
          repo: stroke
          tag: ${{ github.ref_name }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "${{ runner.temp }}/stroke-binaries-${{ github.ref_name }}.tar.gz"
          artifactErrorsFailBuild: true
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: true
